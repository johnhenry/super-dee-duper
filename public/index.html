<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Duplicate File Manager</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f8f8;
        --text-primary: #000000;
        --text-secondary: #666666;
        --border-color: #e0e0e0;
        --accent-color: #7c3aed;
        --delete-color: #ef4444;
        --success-color: #10b981;
        --warning-color: #f59e0b;
      }

      [data-theme="dark"] {
        --bg-primary: #18181b;
        --bg-secondary: #27272a;
        --text-primary: #ffffff;
        --text-secondary: #a1a1aa;
        --border-color: #3f3f46;
        --accent-color: #8b5cf6;
        --delete-color: #f87171;
        --success-color: #34d399;
        --warning-color: #fbbf24;
      }

      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s, color 0.3s;
        line-height: 1.5;
      }

      .header-container {
        position: sticky;
        top: 0;
        background: var(--bg-primary);
        z-index: 100;
        border-bottom: 1px solid var(--border-color);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .stats {
        background: var(--bg-secondary);
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        display: flex;
        gap: 20px;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--accent-color);
      }

      .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
      }

      h1 {
        font-size: 28px;
        font-weight: 600;
        margin: 0;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .theme-toggle {
        background: none;
        border: 1px solid var(--border-color);
        padding: 8px;
        cursor: pointer;
        color: var(--text-primary);
      }

      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .group {
        background: var(--bg-secondary);
        margin: 20px 0;
        border: 1px solid var(--border-color);
      }

      .group-header {
        display: flex;
        align-items: center;
        padding: 15px;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
        border-bottom: 1px solid var(--border-color);
        background: var(--accent-color);
        color: white;
      }

      .group-header h3 {
        margin: 0;
        flex-grow: 1;
        font-size: 18px;
        font-weight: 600;
      }

      .group-content {
        padding: 0;
      }

      .file {
        display: flex;
        align-items: center;
        padding: 10px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
      }

      .file:last-child {
        border-bottom: none;
      }

      .file-select {
        margin-right: 15px;
      }

      .file-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .file-icon {
        font-size: 20px;
        width: 24px;
        text-align: center;
      }

      .file-details {
        flex-grow: 1;
      }

      .file-path {
        word-break: break-all;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .file-meta {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .actions {
        display: flex;
        gap: 5px;
        align-items: center;
      }

      button {
        padding: 8px 16px;
        background: var(--accent-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 14px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      button:hover {
        filter: brightness(110%);
      }

      button:active {
        filter: brightness(90%);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .delete {
        background: var(--delete-color);
      }

      .download {
        background: var(--success-color);
      }

      .preview-btn {
        background: var(--warning-color);
      }

      input[type="text"] {
        padding: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 32px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .rename-container {
        display: flex;
        gap: 5px;
      }

      .rename-container input {
        width: 120px;
      }

      .top-actions {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-input {
        flex: 1;
        min-width: 200px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
      }

      select {
        padding: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
        height: 32px;
        font-size: 14px;
      }

      .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        padding: 20px;
      }

      .preview-content {
        max-width: 90%;
        max-height: 90%;
        margin: 20px auto;
        background: var(--bg-primary);
        padding: 20px;
        overflow: auto;
      }

      .preview-image {
        max-width: 100%;
        height: auto;
      }

      .preview-text {
        white-space: pre-wrap;
        font-family: "Cascadia Code", Consolas, monospace;
      }

      .close-preview {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
      }

      .collapse-indicator {
        margin-right: 10px;
        transition: transform 0.3s;
        color: white;
      }

      .collapsed .collapse-indicator {
        transform: rotate(-90deg);
      }

      .collapsed .group-content {
        display: none;
      }

      .batch-rename {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
      }

      @media (max-width: 768px) {
        .actions {
          flex-wrap: wrap;
        }

        .file {
          flex-direction: column;
          gap: 10px;
        }

        .file-select {
          align-self: flex-start;
        }

        .actions {
          width: 100%;
          justify-content: flex-end;
        }

        .rename-container {
          width: 100%;
        }

        .rename-container input {
          flex-grow: 1;
          width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <div class="header-content">
        <div class="header">
          <h1>Duplicate File Manager</h1>
          <div class="controls">
            <button
              class="theme-toggle"
              onclick="toggleTheme()"
              aria-label="Toggle dark mode"
            >
              🌓
            </button>
          </div>
        </div>

        <div class="stats" id="stats">
          <div class="stat-item">
            <div class="stat-value" id="totalGroups">0</div>
            <div class="stat-label">Groups</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalFiles">0</div>
            <div class="stat-label">Files</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalSize">0</div>
            <div class="stat-label">Total Size</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="potentialSavings">0</div>
            <div class="stat-label">Potential Savings</div>
          </div>
        </div>

        <div class="filters">
          <div class="filter-group">
            <label for="pathFilter" class="filter-label">Filter by path</label>
            <input
              type="text"
              id="pathFilter"
              class="filter-input"
              placeholder="Enter path to filter..."
              oninput="applyFilters()"
            />
          </div>
          <div class="filter-group">
            <label for="sizeFilter" class="filter-label">Filter by size</label>
            <select
              id="sizeFilter"
              onchange="applyFilters()"
              aria-label="Filter by file size"
            >
              <option value="">All Sizes</option>
              <option value="small">Small (<1MB)</option>
              <option value="medium">Medium (1-10MB)</option>
              <option value="large">Large (>10MB)</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="typeFilter" class="filter-label">Filter by type</label>
            <select
              id="typeFilter"
              onchange="applyFilters()"
              aria-label="Filter by file type"
            >
              <option value="">All Types</option>
              <option value="image">Images</option>
              <option value="document">Documents</option>
              <option value="video">Videos</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="top-actions">
          <button onclick="toggleAllGroups()">Toggle All Groups</button>
          <button onclick="showBatchRename()">Batch Rename</button>
          <button
            class="delete-selected"
            onclick="deleteSelected()"
            disabled
            id="deleteSelectedBtn"
          >
            Delete Selected
          </button>
          <button class="shutdown-btn" onclick="shutdown()">
            Shutdown Server
          </button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div id="groups"></div>
    </div>

    <div
      class="preview-modal"
      id="previewModal"
      role="dialog"
      aria-label="File preview"
    >
      <button
        class="close-preview"
        onclick="closePreview()"
        aria-label="Close preview"
      >
        ×
      </button>
      <div class="preview-content" id="previewContent"></div>
    </div>

    <script>
      // Theme management
      function toggleTheme() {
        const theme =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
      }

      // Initialize theme
      const savedTheme = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);

      let duplicateGroups = [];
      let allGroupsExpanded = true;

      function getFileIcon(path) {
        const ext = path.toLowerCase().split(".").pop();
        const imageExts = ["jpg", "jpeg", "png", "gif", "bmp", "webp"];
        const documentExts = ["pdf", "doc", "docx", "txt", "md", "rtf"];
        const videoExts = ["mp4", "avi", "mov", "wmv", "flv", "mkv"];

        if (imageExts.includes(ext)) return "🖼️";
        if (documentExts.includes(ext)) return "📄";
        if (videoExts.includes(ext)) return "🎥";
        return "📁";
      }

      function updateStats() {
        const totalGroups = duplicateGroups.length;
        const totalFiles = duplicateGroups.reduce(
          (sum, group) => sum + group.length,
          0
        );
        const totalSize = duplicateGroups.reduce((sum, group) => {
          return sum + group[0].size * group.length;
        }, 0);
        const potentialSavings = duplicateGroups.reduce((sum, group) => {
          return sum + group[0].size * (group.length - 1);
        }, 0);

        document.getElementById("totalGroups").textContent = totalGroups;
        document.getElementById("totalFiles").textContent = totalFiles;
        document.getElementById("totalSize").textContent =
          formatSize(totalSize);
        document.getElementById("potentialSavings").textContent =
          formatSize(potentialSavings);
      }

      function formatSize(bytes) {
        const units = ["B", "KB", "MB", "GB", "TB"];
        let size = bytes;
        let unitIndex = 0;

        while (size >= 1024 && unitIndex < units.length - 1) {
          size /= 1024;
          unitIndex++;
        }

        return `${size.toFixed(1)}${units[unitIndex]}`;
      }

      function toggleAllGroups() {
        allGroupsExpanded = !allGroupsExpanded;
        document.querySelectorAll(".group").forEach((group) => {
          if (allGroupsExpanded) {
            group.classList.remove("collapsed");
          } else {
            group.classList.add("collapsed");
          }
        });
      }

      function toggleGroup(groupIndex) {
        const group = document.querySelector(
          `.group[data-group-index="${groupIndex}"]`
        );
        group.classList.toggle("collapsed");
      }

      function showBatchRename() {
        const selectedFiles = Array.from(
          document.querySelectorAll(".file-checkbox:checked")
        ).map((checkbox) => checkbox.dataset.path);

        if (selectedFiles.length === 0) {
          alert("Please select files to rename");
          return;
        }

        const pattern = prompt(
          "Enter rename pattern:\n{n} = original name\n{i} = index\n{ext} = extension"
        );
        if (!pattern) return;

        batchRename(selectedFiles, pattern);
      }

      async function batchRename(files, pattern) {
        for (let i = 0; i < files.length; i++) {
          const oldPath = files[i];
          const oldName = oldPath.split("/").pop();
          const ext = oldName.includes(".") ? oldName.split(".").pop() : "";
          const baseName = oldName.includes(".")
            ? oldName.slice(0, -ext.length - 1)
            : oldName;

          const newName = pattern
            .replace("{n}", baseName)
            .replace("{i}", (i + 1).toString().padStart(2, "0"))
            .replace("{ext}", ext ? `.${ext}` : "");

          try {
            await fetch("/api/rename", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ oldPath, newName }),
            });
          } catch (error) {
            console.error(`Failed to rename ${oldPath}:`, error);
          }
        }

        loadDuplicates();
      }

      function getFileType(path) {
        const ext = path.toLowerCase().split(".").pop();
        const imageExts = ["jpg", "jpeg", "png", "gif", "bmp", "webp"];
        const documentExts = ["pdf", "doc", "docx", "txt", "md", "rtf"];
        const videoExts = ["mp4", "avi", "mov", "wmv", "flv", "mkv"];

        if (imageExts.includes(ext)) return "image";
        if (documentExts.includes(ext)) return "document";
        if (videoExts.includes(ext)) return "video";
        return "other";
      }

      function formatDate(date) {
        return new Date(date).toLocaleString();
      }

      async function loadDuplicates() {
        const response = await fetch("/api/duplicates");
        duplicateGroups = await response.json();
        renderGroups();
        updateStats();
      }

      function applyFilters() {
        renderGroups();
      }

      function renderGroups() {
        const pathFilter = document
          .getElementById("pathFilter")
          .value.toLowerCase();
        const sizeFilter = document.getElementById("sizeFilter").value;
        const typeFilter = document.getElementById("typeFilter").value;

        const filteredGroups = duplicateGroups.filter((group) => {
          // Apply size filter
          const size = group[0].size;
          if (sizeFilter === "small" && size >= 1024 * 1024) return false;
          if (
            sizeFilter === "medium" &&
            (size < 1024 * 1024 || size > 10 * 1024 * 1024)
          )
            return false;
          if (sizeFilter === "large" && size <= 10 * 1024 * 1024) return false;

          // Apply path and type filters
          return group.some((file) => {
            const matchesPath = file.path.toLowerCase().includes(pathFilter);
            const matchesType =
              !typeFilter || getFileType(file.path) === typeFilter;
            return matchesPath && matchesType;
          });
        });

        const container = document.getElementById("groups");
        container.innerHTML = filteredGroups
          .map((group, groupIndex) => {
            const hash = group[0].hash;
            return `
          <div class="group" data-group-index="${groupIndex}">
            <div class="group-header" onclick="toggleGroup(${groupIndex})">
              <span class="collapse-indicator">▼</span>
              <h3>Group ${groupIndex + 1} - ${group[0].formattedSize} - ${
              hash ? hash.slice(0, 8) : "calculating..."
            }</h3>
              <label>
                <input type="checkbox" 
                       onchange="toggleGroupSelection(${groupIndex}, this.checked); event.stopPropagation();" 
                       class="group-checkbox"
                       aria-label="Select all files in group ${groupIndex + 1}">
                Select All
              </label>
            </div>
            <div class="group-content">
              ${group
                .map(
                  (file, fileIndex) => `
                <div class="file" data-file-index="${fileIndex}">
                  <div class="file-select">
                    <input type="checkbox" 
                           class="file-checkbox" 
                           data-path="${file.path}"
                           onchange="updateDeleteButton()"
                           aria-label="Select ${file.path}">
                  </div>
                  <div class="file-info">
                    <div class="file-icon">${getFileIcon(file.path)}</div>
                    <div class="file-details">
                      <div class="file-path">${file.path}</div>
                      <div class="file-meta">
                        <span>Size: ${file.formattedSize}</span>
                        <span>Modified: ${formatDate(file.modified)}</span>
                        <span>Created: ${formatDate(file.created)}</span>
                      </div>
                    </div>
                  </div>
                  <div class="actions">
                    <div class="rename-container">
                      <input type="text" 
                             placeholder="New name" 
                             onkeyup="if(event.key==='Enter') renameFile(${groupIndex}, ${fileIndex}, this)"
                             aria-label="New name for ${file.path}">
                      <button class="rename-btn" 
                              onclick="renameFile(${groupIndex}, ${fileIndex}, this.previousElementSibling)">
                        Rename
                      </button>
                    </div>
                    <button class="preview-btn" onclick="previewFile('${
                      file.path
                    }')" aria-label="Preview ${file.path}">Preview</button>
                    <button class="download" onclick="downloadFile('${
                      file.path
                    }')" aria-label="Download ${file.path}">Download</button>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `;
          })
          .join("");

        updateDeleteButton();
      }

      function updateDeleteButton() {
        const selectedCount = document.querySelectorAll(
          ".file-checkbox:checked"
        ).length;
        const deleteBtn = document.getElementById("deleteSelectedBtn");
        deleteBtn.disabled = selectedCount === 0;
        deleteBtn.textContent = `Delete Selected (${selectedCount})`;
      }

      function toggleGroupSelection(groupIndex, checked) {
        const group = document.querySelector(
          `.group[data-group-index="${groupIndex}"]`
        );
        group.querySelectorAll(".file-checkbox").forEach((checkbox) => {
          checkbox.checked = checked;
        });
        updateDeleteButton();
      }

      async function deleteSelected() {
        const selectedPaths = Array.from(
          document.querySelectorAll(".file-checkbox:checked")
        ).map((checkbox) => checkbox.dataset.path);

        if (
          !confirm(
            `Are you sure you want to delete ${selectedPaths.length} file(s)?`
          )
        )
          return;

        for (const path of selectedPaths) {
          await fetch("/api/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filePath: path }),
          });
        }

        loadDuplicates();
      }

      async function renameFile(groupIndex, fileIndex, input) {
        if (!input.value) return;

        const group = document.querySelector(
          `.group[data-group-index="${groupIndex}"]`
        );
        const file = group.querySelector(
          `.file[data-file-index="${fileIndex}"]`
        );
        const oldPath = file.querySelector(".file-checkbox").dataset.path;

        try {
          const response = await fetch("/api/rename", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ oldPath, newName: input.value }),
          });

          if (response.ok) {
            const result = await response.json();
            file.querySelector(".file-info").firstElementChild.textContent =
              result.newPath;
            file.querySelector(".file-checkbox").dataset.path = result.newPath;
            input.value = "";
            loadDuplicates(); // Reload to update all metadata
          }
        } catch (error) {
          alert("Failed to rename file: " + error.message);
        }
      }

      async function previewFile(path) {
        const modal = document.getElementById("previewModal");
        const content = document.getElementById("previewContent");
        const fileType = getFileType(path);

        modal.style.display = "block";
        content.innerHTML = "Loading preview...";

        try {
          if (fileType === "image") {
            content.innerHTML = `<img src="/api/download/${encodeURIComponent(
              path
            )}" class="preview-image" alt="Preview of ${path}">`;
          } else {
            const response = await fetch(
              `/api/download/${encodeURIComponent(path)}`
            );
            const text = await response.text();
            content.innerHTML = `<pre class="preview-text">${text}</pre>`;
          }
        } catch (error) {
          content.innerHTML = "Failed to load preview";
        }
      }

      function closePreview() {
        document.getElementById("previewModal").style.display = "none";
      }

      function downloadFile(path) {
        const encodedPath = encodeURIComponent(path);
        window.location.href = `/api/download/${encodedPath}`;
      }

      async function shutdown() {
        if (!confirm("Are you sure you want to shutdown the server?")) return;
        try {
          await fetch("/api/shutdown", { method: "POST" });
          document.body.innerHTML =
            "<h1>Server has been shut down</h1><p>You can close this window now.</p>";
        } catch (error) {
          document.body.innerHTML =
            "<h1>Server has been shut down</h1><p>You can close this window now.</p>";
        }
      }

      // Initialize
      loadDuplicates();

      // Close preview modal when clicking outside
      document
        .getElementById("previewModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closePreview();
        });

      // Handle Escape key to close preview
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") closePreview();
      });
    </script>
  </body>
</html>
